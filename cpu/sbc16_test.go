package cpu

import (
	"testing"
	"z80/dma"
	"z80/memory"
)

var sbc16TruthTable [288][10]uint16 = [288][10]uint16{
	// a, r, C before, a-r, C, N, PV, H, Z, S
	[10]uint16{0x0000, 0x0000, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0000, 0x0001, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x007f, 0, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0080, 0, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0081, 0, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x00fe, 0, 0xff02, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x00ff, 0, 0xff01, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0100, 0, 0xff00, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x7fff, 0, 0x8001, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x8000, 0, 0x8000, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0000, 0x8001, 0, 0x7fff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0000, 0xffff, 0, 0x0001, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0001, 0x0000, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0001, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0001, 0x007f, 0, 0xff82, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0080, 0, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0081, 0, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x00fe, 0, 0xff03, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x00ff, 0, 0xff02, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0100, 0, 0xff01, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x7fff, 0, 0x8002, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x8000, 0, 0x8001, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0001, 0x8001, 0, 0x8000, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0001, 0xffff, 0, 0x0002, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x007f, 0x0000, 0, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0001, 0, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x007f, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x007f, 0x0080, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x0081, 0, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x00fe, 0, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x00ff, 0, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x0100, 0, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x7fff, 0, 0x8080, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x8000, 0, 0x807f, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x007f, 0x8001, 0, 0x807e, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x007f, 0xffff, 0, 0x0080, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0080, 0x0000, 0, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0001, 0, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x007f, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0080, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0080, 0x0081, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x00fe, 0, 0xff82, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x00ff, 0, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x0100, 0, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x7fff, 0, 0x8081, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x8000, 0, 0x8080, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0080, 0x8001, 0, 0x807f, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0080, 0xffff, 0, 0x0081, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0081, 0x0000, 0, 0x0081, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0001, 0, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x007f, 0, 0x0002, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0080, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0081, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0081, 0x00fe, 0, 0xff83, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x00ff, 0, 0xff82, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x0100, 0, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x7fff, 0, 0x8082, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x8000, 0, 0x8081, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0081, 0x8001, 0, 0x8080, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0081, 0xffff, 0, 0x0082, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x00fe, 0x0000, 0, 0x00fe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0001, 0, 0x00fd, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x007f, 0, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0080, 0, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0081, 0, 0x007d, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00fe, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x00fe, 0x00ff, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x0100, 0, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x7fff, 0, 0x80ff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x8000, 0, 0x80fe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00fe, 0x8001, 0, 0x80fd, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00fe, 0xffff, 0, 0x00ff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x00ff, 0x0000, 0, 0x00ff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0001, 0, 0x00fe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x007f, 0, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0080, 0, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0081, 0, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00fe, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00ff, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x00ff, 0x0100, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00ff, 0x7fff, 0, 0x8100, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00ff, 0x8000, 0, 0x80ff, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00ff, 0x8001, 0, 0x80fe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00ff, 0xffff, 0, 0x0100, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0100, 0x0000, 0, 0x0100, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0001, 0, 0x00ff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x007f, 0, 0x0081, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0080, 0, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0081, 0, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00fe, 0, 0x0002, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00ff, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0100, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0100, 0x7fff, 0, 0x8101, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0100, 0x8000, 0, 0x8100, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0100, 0x8001, 0, 0x80ff, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0100, 0xffff, 0, 0x0101, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x7fff, 0x0000, 0, 0x7fff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0001, 0, 0x7ffe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x007f, 0, 0x7f80, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0080, 0, 0x7f7f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0081, 0, 0x7f7e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x00fe, 0, 0x7f01, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x00ff, 0, 0x7f00, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0100, 0, 0x7eff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x7fff, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x7fff, 0x8000, 0, 0xffff, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x7fff, 0x8001, 0, 0xfffe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x7fff, 0xffff, 0, 0x8000, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x8000, 0x0000, 0, 0x8000, 0, 1, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0001, 0, 0x7fff, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x007f, 0, 0x7f81, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0080, 0, 0x7f80, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0081, 0, 0x7f7f, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x00fe, 0, 0x7f02, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x00ff, 0, 0x7f01, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0100, 0, 0x7f00, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x7fff, 0, 0x0001, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x8000, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x8000, 0x8001, 0, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8000, 0xffff, 0, 0x8001, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8001, 0x0000, 0, 0x8001, 0, 1, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0001, 0, 0x8000, 0, 1, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x007f, 0, 0x7f82, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0080, 0, 0x7f81, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0081, 0, 0x7f80, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x00fe, 0, 0x7f03, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x00ff, 0, 0x7f02, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0100, 0, 0x7f01, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x7fff, 0, 0x0002, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x8000, 0, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x8001, 0x8001, 0, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x8001, 0xffff, 0, 0x8002, 1, 1, 0, 1, 0, 1},
	[10]uint16{0xffff, 0x0000, 0, 0xffff, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0001, 0, 0xfffe, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x007f, 0, 0xff80, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0080, 0, 0xff7f, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0081, 0, 0xff7e, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x00fe, 0, 0xff01, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x00ff, 0, 0xff00, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0100, 0, 0xfeff, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x7fff, 0, 0x8000, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x8000, 0, 0x7fff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0xffff, 0x8001, 0, 0x7ffe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0xffff, 0xffff, 0, 0x0000, 0, 1, 0, 0, 1, 0},

	[10]uint16{0x0000, 0x0000, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0001, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x007f, 1, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0080, 1, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0081, 1, 0xff7e, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x00fe, 1, 0xff01, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x00ff, 1, 0xff00, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x0100, 1, 0xfeff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x7fff, 1, 0x8000, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0000, 0x8000, 1, 0x7fff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0000, 0x8001, 1, 0x7ffe, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0000, 0xffff, 1, 0x0000, 1, 1, 0, 1, 1, 0},
	[10]uint16{0x0001, 0x0000, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0001, 0x0001, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x007f, 1, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0080, 1, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0081, 1, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x00fe, 1, 0xff02, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x00ff, 1, 0xff01, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x0100, 1, 0xff00, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x7fff, 1, 0x8001, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0001, 0x8000, 1, 0x8000, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0001, 0x8001, 1, 0x7fff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0001, 0xffff, 1, 0x0001, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x007f, 0x0000, 1, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0001, 1, 0x007d, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x007f, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x0080, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x0081, 1, 0xfffd, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x00fe, 1, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x00ff, 1, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x0100, 1, 0xff7e, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x7fff, 1, 0x807f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x007f, 0x8000, 1, 0x807e, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x007f, 0x8001, 1, 0x807d, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x007f, 0xffff, 1, 0x007f, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0080, 0x0000, 1, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0001, 1, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x007f, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0080, 0x0080, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x0081, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x00fe, 1, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x00ff, 1, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x0100, 1, 0xff7f, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x7fff, 1, 0x8080, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0080, 0x8000, 1, 0x807f, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0080, 0x8001, 1, 0x807e, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0080, 0xffff, 1, 0x0080, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0081, 0x0000, 1, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0001, 1, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x007f, 1, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0080, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0081, 0x0081, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x00fe, 1, 0xff82, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x00ff, 1, 0xff81, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x0100, 1, 0xff80, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x7fff, 1, 0x8081, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0081, 0x8000, 1, 0x8080, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0081, 0x8001, 1, 0x807f, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0081, 0xffff, 1, 0x0081, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x00fe, 0x0000, 1, 0x00fd, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0001, 1, 0x00fc, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x007f, 1, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0080, 1, 0x007d, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0081, 1, 0x007c, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00fe, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x00ff, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x0100, 1, 0xfffd, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x7fff, 1, 0x80fe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00fe, 0x8000, 1, 0x80fd, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00fe, 0x8001, 1, 0x80fc, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00fe, 0xffff, 1, 0x00fe, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x00ff, 0x0000, 1, 0x00fe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0001, 1, 0x00fd, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x007f, 1, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0080, 1, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0081, 1, 0x007d, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00fe, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x00ff, 0x00ff, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00ff, 0x0100, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00ff, 0x7fff, 1, 0x80ff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x00ff, 0x8000, 1, 0x80fe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00ff, 0x8001, 1, 0x80fd, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x00ff, 0xffff, 1, 0x00ff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x0100, 0x0000, 1, 0x00ff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0001, 1, 0x00fe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x007f, 1, 0x0080, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0080, 1, 0x007f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0081, 1, 0x007e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00fe, 1, 0x0001, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00ff, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x0100, 0x0100, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0100, 0x7fff, 1, 0x8100, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x0100, 0x8000, 1, 0x80ff, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0100, 0x8001, 1, 0x80fe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x0100, 0xffff, 1, 0x0100, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x7fff, 0x0000, 1, 0x7ffe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0001, 1, 0x7ffd, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x007f, 1, 0x7f7f, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0080, 1, 0x7f7e, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0081, 1, 0x7f7d, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x00fe, 1, 0x7f00, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x00ff, 1, 0x7eff, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0100, 1, 0x7efe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x7fff, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x7fff, 0x8000, 1, 0xfffe, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x7fff, 0x8001, 1, 0xfffd, 1, 1, 1, 0, 0, 1},
	[10]uint16{0x7fff, 0xffff, 1, 0x7fff, 1, 1, 0, 1, 0, 0},
	[10]uint16{0x8000, 0x0000, 1, 0x7fff, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0001, 1, 0x7ffe, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x007f, 1, 0x7f80, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0080, 1, 0x7f7f, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0081, 1, 0x7f7e, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x00fe, 1, 0x7f01, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x00ff, 1, 0x7f00, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x0100, 1, 0x7eff, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8000, 0x7fff, 1, 0x0000, 0, 1, 1, 1, 1, 0},
	[10]uint16{0x8000, 0x8000, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8000, 0x8001, 1, 0xfffe, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8000, 0xffff, 1, 0x8000, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8001, 0x0000, 1, 0x8000, 0, 1, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0001, 1, 0x7fff, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x007f, 1, 0x7f81, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0080, 1, 0x7f80, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0081, 1, 0x7f7f, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x00fe, 1, 0x7f02, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x00ff, 1, 0x7f01, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x0100, 1, 0x7f00, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x7fff, 1, 0x0001, 0, 1, 1, 1, 0, 0},
	[10]uint16{0x8001, 0x8000, 1, 0x0000, 0, 1, 0, 0, 1, 0},
	[10]uint16{0x8001, 0x8001, 1, 0xffff, 1, 1, 0, 1, 0, 1},
	[10]uint16{0x8001, 0xffff, 1, 0x8001, 1, 1, 0, 1, 0, 1},
	[10]uint16{0xffff, 0x0000, 1, 0xfffe, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0001, 1, 0xfffd, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x007f, 1, 0xff7f, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0080, 1, 0xff7e, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0081, 1, 0xff7d, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x00fe, 1, 0xff00, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x00ff, 1, 0xfeff, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0100, 1, 0xfefe, 0, 1, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x7fff, 1, 0x7fff, 0, 1, 1, 1, 0, 0},
	[10]uint16{0xffff, 0x8000, 1, 0x7ffe, 0, 1, 0, 0, 0, 0},
	[10]uint16{0xffff, 0x8001, 1, 0x7ffd, 0, 1, 0, 0, 0, 0},
	[10]uint16{0xffff, 0xffff, 1, 0xffff, 1, 1, 0, 1, 0, 1},
}

func TestSbc16bit(t *testing.T) {
	var mem = memory.MemoryNew()
	var dmaX = dma.DMANew(mem)
	var cpu = CPUNew(dmaX)

	for _, row := range sbc16TruthTable {
		for _, registerPair := range [4]string{"BC", "DE", "HL", "SP"} {
			if registerPair == "HL" {
				if row[0] != row[1] {
					continue
				}
			}

			cpu.PC = 0
			cpu.setC(row[2] == 1)
			cpu.BC = row[1]
			cpu.DE = row[1]
			cpu.HL = row[0]
			cpu.SP = row[1]
			tstates := cpu.sbcHlRr(registerPair)()

			if cpu.HL != row[3] || cpu.getC() != (row[4] == 1) || cpu.getN() != (row[5] == 1) || cpu.getPV() != (row[6] == 1) || cpu.getH() != (row[7] == 1) || cpu.getZ() != (row[8] == 1) || cpu.getS() != (row[9] == 1) {
				t.Errorf(
					"\ngot:  HL=0x%04x, C=%t, N=%t, PV=%t, H=%t, Z=%t, S=%t\nwant: HL=0x%04x, C=%t, N=%t, PV=%t, H=%t, Z=%t, S=%t for (%d - %d - %d)",
					cpu.HL, cpu.getC(), cpu.getN(), cpu.getPV(), cpu.getH(), cpu.getZ(), cpu.getS(),
					row[3], row[4] == 1, row[5] == 1, row[6] == 1, row[7] == 1, row[8] == 1, row[9] == 1, row[0], row[1], row[2],
				)
				return
			}

			if cpu.PC != 2 || tstates != 15 {
				t.Errorf("got PC=%d, %d T-states, want PC=%d, %d T-states", cpu.PC, tstates, 2, 15)
			}
		}
	}
}
