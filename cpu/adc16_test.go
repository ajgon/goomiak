package cpu

import (
	"testing"
	"z80/dma"
	"z80/memory"
)

var adc16TruthTable [288][10]uint16 = [288][10]uint16{
	// a, r, C before, a-r, C, N, PV, H, Z, S
	[10]uint16{0x0000, 0x0000, 0, 0x0000, 0, 0, 0, 0, 1, 0},
	[10]uint16{0x0000, 0x0001, 0, 0x0001, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x007f, 0, 0x007f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0080, 0, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0081, 0, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x00fe, 0, 0x00fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x00ff, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0100, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x7fff, 0, 0x7fff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x8000, 0, 0x8000, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0000, 0x8001, 0, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0000, 0xffff, 0, 0xffff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0001, 0x0000, 0, 0x0001, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0001, 0, 0x0002, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x007f, 0, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0080, 0, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0081, 0, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x00fe, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x00ff, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0100, 0, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x7fff, 0, 0x8000, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0001, 0x8000, 0, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0001, 0x8001, 0, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0001, 0xffff, 0, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x007f, 0x0000, 0, 0x007f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0001, 0, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x007f, 0, 0x00fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0080, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0081, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x00fe, 0, 0x017d, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x00ff, 0, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0100, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x7fff, 0, 0x807e, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x007f, 0x8000, 0, 0x807f, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x007f, 0x8001, 0, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x007f, 0xffff, 0, 0x007e, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0080, 0x0000, 0, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0001, 0, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x007f, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0080, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0081, 0, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x00fe, 0, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x00ff, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0100, 0, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x7fff, 0, 0x807f, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0080, 0x8000, 0, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0080, 0x8001, 0, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0080, 0xffff, 0, 0x007f, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0081, 0x0000, 0, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0001, 0, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x007f, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0080, 0, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0081, 0, 0x0102, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x00fe, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x00ff, 0, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0100, 0, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x7fff, 0, 0x8080, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0081, 0x8000, 0, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0081, 0x8001, 0, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0081, 0xffff, 0, 0x0080, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x00fe, 0x0000, 0, 0x00fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0001, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x007f, 0, 0x017d, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0080, 0, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0081, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00fe, 0, 0x01fc, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00ff, 0, 0x01fd, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0100, 0, 0x01fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x7fff, 0, 0x80fd, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x00fe, 0x8000, 0, 0x80fe, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00fe, 0x8001, 0, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00fe, 0xffff, 0, 0x00fd, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x00ff, 0x0000, 0, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0001, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x007f, 0, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0080, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0081, 0, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00fe, 0, 0x01fd, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00ff, 0, 0x01fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0100, 0, 0x01ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x7fff, 0, 0x80fe, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x00ff, 0x8000, 0, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00ff, 0x8001, 0, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00ff, 0xffff, 0, 0x00fe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0100, 0x0000, 0, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0001, 0, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x007f, 0, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0080, 0, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0081, 0, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00fe, 0, 0x01fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00ff, 0, 0x01ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0100, 0, 0x0200, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x7fff, 0, 0x80ff, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0100, 0x8000, 0, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0100, 0x8001, 0, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0100, 0xffff, 0, 0x00ff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x7fff, 0x0000, 0, 0x7fff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x7fff, 0x0001, 0, 0x8000, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x007f, 0, 0x807e, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0080, 0, 0x807f, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0081, 0, 0x8080, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x00fe, 0, 0x80fd, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x00ff, 0, 0x80fe, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0100, 0, 0x80ff, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x7fff, 0, 0xfffe, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x8000, 0, 0xffff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x7fff, 0x8001, 0, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x7fff, 0xffff, 0, 0x7ffe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x8000, 0x0000, 0, 0x8000, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0001, 0, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x007f, 0, 0x807f, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0080, 0, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0081, 0, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x00fe, 0, 0x80fe, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x00ff, 0, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0100, 0, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x7fff, 0, 0xffff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x8000, 0, 0x0000, 1, 0, 1, 0, 1, 0},
	[10]uint16{0x8000, 0x8001, 0, 0x0001, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8000, 0xffff, 0, 0x7fff, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8001, 0x0000, 0, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0001, 0, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x007f, 0, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0080, 0, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0081, 0, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x00fe, 0, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x00ff, 0, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0100, 0, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x7fff, 0, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x8001, 0x8000, 0, 0x0001, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8001, 0x8001, 0, 0x0002, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8001, 0xffff, 0, 0x8000, 1, 0, 0, 1, 0, 1},
	[10]uint16{0xffff, 0x0000, 0, 0xffff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0xffff, 0x0001, 0, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0xffff, 0x007f, 0, 0x007e, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0080, 0, 0x007f, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0081, 0, 0x0080, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x00fe, 0, 0x00fd, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x00ff, 0, 0x00fe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0100, 0, 0x00ff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x7fff, 0, 0x7ffe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x8000, 0, 0x7fff, 1, 0, 1, 0, 0, 0},
	[10]uint16{0xffff, 0x8001, 0, 0x8000, 1, 0, 0, 1, 0, 1},
	[10]uint16{0xffff, 0xffff, 0, 0xfffe, 1, 0, 0, 1, 0, 1},

	[10]uint16{0x0000, 0x0000, 1, 0x0001, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0001, 1, 0x0002, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x007f, 1, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0080, 1, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0081, 1, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x00fe, 1, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x00ff, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x0100, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0000, 0x7fff, 1, 0x8000, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0000, 0x8000, 1, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0000, 0x8001, 1, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0000, 0xffff, 1, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x0001, 0x0000, 1, 0x0002, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0001, 1, 0x0003, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x007f, 1, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0080, 1, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0081, 1, 0x0083, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x00fe, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x00ff, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x0100, 1, 0x0102, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0001, 0x7fff, 1, 0x8001, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0001, 0x8000, 1, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0001, 0x8001, 1, 0x8003, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0001, 0xffff, 1, 0x0001, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x007f, 0x0000, 1, 0x0080, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0001, 1, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x007f, 1, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0080, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0081, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x00fe, 1, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x00ff, 1, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x0100, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x007f, 0x7fff, 1, 0x807f, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x007f, 0x8000, 1, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x007f, 0x8001, 1, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x007f, 0xffff, 1, 0x007f, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0080, 0x0000, 1, 0x0081, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0001, 1, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x007f, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0080, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0081, 1, 0x0102, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x00fe, 1, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x00ff, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x0100, 1, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0080, 0x7fff, 1, 0x8080, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0080, 0x8000, 1, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0080, 0x8001, 1, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0080, 0xffff, 1, 0x0080, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0081, 0x0000, 1, 0x0082, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0001, 1, 0x0083, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x007f, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0080, 1, 0x0102, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0081, 1, 0x0103, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x00fe, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x00ff, 1, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x0100, 1, 0x0182, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0081, 0x7fff, 1, 0x8081, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0081, 0x8000, 1, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0081, 0x8001, 1, 0x8083, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0081, 0xffff, 1, 0x0081, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x00fe, 0x0000, 1, 0x00ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0001, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x007f, 1, 0x017e, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0080, 1, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0081, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00fe, 1, 0x01fd, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x00ff, 1, 0x01fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x0100, 1, 0x01ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00fe, 0x7fff, 1, 0x80fe, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x00fe, 0x8000, 1, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00fe, 0x8001, 1, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00fe, 0xffff, 1, 0x00fe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x00ff, 0x0000, 1, 0x0100, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0001, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x007f, 1, 0x017f, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0080, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0081, 1, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00fe, 1, 0x01fe, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x00ff, 1, 0x01ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x0100, 1, 0x0200, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x00ff, 0x7fff, 1, 0x80ff, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x00ff, 0x8000, 1, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00ff, 0x8001, 1, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x00ff, 0xffff, 1, 0x00ff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x0100, 0x0000, 1, 0x0101, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0001, 1, 0x0102, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x007f, 1, 0x0180, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0080, 1, 0x0181, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0081, 1, 0x0182, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00fe, 1, 0x01ff, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x00ff, 1, 0x0200, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x0100, 1, 0x0201, 0, 0, 0, 0, 0, 0},
	[10]uint16{0x0100, 0x7fff, 1, 0x8100, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x0100, 0x8000, 1, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0100, 0x8001, 1, 0x8102, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x0100, 0xffff, 1, 0x0100, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x7fff, 0x0000, 1, 0x8000, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0001, 1, 0x8001, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x007f, 1, 0x807f, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0080, 1, 0x8080, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0081, 1, 0x8081, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x00fe, 1, 0x80fe, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x00ff, 1, 0x80ff, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x0100, 1, 0x8100, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x7fff, 1, 0xffff, 0, 0, 1, 1, 0, 1},
	[10]uint16{0x7fff, 0x8000, 1, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x7fff, 0x8001, 1, 0x0001, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x7fff, 0xffff, 1, 0x7fff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x8000, 0x0000, 1, 0x8001, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0001, 1, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x007f, 1, 0x8080, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0080, 1, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0081, 1, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x00fe, 1, 0x80ff, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x00ff, 1, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x0100, 1, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8000, 0x7fff, 1, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0x8000, 0x8000, 1, 0x0001, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8000, 0x8001, 1, 0x0002, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8000, 0xffff, 1, 0x8000, 1, 0, 0, 1, 0, 1},
	[10]uint16{0x8001, 0x0000, 1, 0x8002, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0001, 1, 0x8003, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x007f, 1, 0x8081, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0080, 1, 0x8082, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0081, 1, 0x8083, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x00fe, 1, 0x8100, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x00ff, 1, 0x8101, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x0100, 1, 0x8102, 0, 0, 0, 0, 0, 1},
	[10]uint16{0x8001, 0x7fff, 1, 0x0001, 1, 0, 0, 1, 0, 0},
	[10]uint16{0x8001, 0x8000, 1, 0x0002, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8001, 0x8001, 1, 0x0003, 1, 0, 1, 0, 0, 0},
	[10]uint16{0x8001, 0xffff, 1, 0x8001, 1, 0, 0, 1, 0, 1},
	[10]uint16{0xffff, 0x0000, 1, 0x0000, 1, 0, 0, 1, 1, 0},
	[10]uint16{0xffff, 0x0001, 1, 0x0001, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x007f, 1, 0x007f, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0080, 1, 0x0080, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0081, 1, 0x0081, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x00fe, 1, 0x00fe, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x00ff, 1, 0x00ff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x0100, 1, 0x0100, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x7fff, 1, 0x7fff, 1, 0, 0, 1, 0, 0},
	[10]uint16{0xffff, 0x8000, 1, 0x8000, 1, 0, 0, 1, 0, 1},
	[10]uint16{0xffff, 0x8001, 1, 0x8001, 1, 0, 0, 1, 0, 1},
	[10]uint16{0xffff, 0xffff, 1, 0xffff, 1, 0, 0, 1, 0, 1},
}

func TestAdc16bit(t *testing.T) {
	var mem = memory.MemoryNew()
	var dmaX = dma.DMANew(mem)
	var cpu = CPUNew(dmaX)

	for _, row := range adc16TruthTable {
		for _, registerPair := range [4]string{"BC", "DE", "HL", "SP"} {
			if registerPair == "HL" {
				if row[0] != row[1] {
					continue
				}
			}

			cpu.PC = 0
			cpu.setC(row[2] == 1)
			cpu.BC = row[1]
			cpu.DE = row[1]
			cpu.HL = row[0]
			cpu.SP = row[1]
			tstates := cpu.adcHlRr(registerPair)()

			if cpu.WZ != row[0]+1 || cpu.HL != row[3] || cpu.getC() != (row[4] == 1) || cpu.getN() != (row[5] == 1) || cpu.getPV() != (row[6] == 1) || cpu.getH() != (row[7] == 1) || cpu.getZ() != (row[8] == 1) || cpu.getS() != (row[9] == 1) {
				t.Errorf(
					"\ngot:  WZ=0x%04x, HL=0x%04x, C=%t, N=%t, PV=%t, H=%t, Z=%t, S=%t\nwant: WZ=0x%04x, HL=0x%04x, C=%t, N=%t, PV=%t, H=%t, Z=%t, S=%t for (%d - %d - %d)",
					cpu.WZ, cpu.HL, cpu.getC(), cpu.getN(), cpu.getPV(), cpu.getH(), cpu.getZ(), cpu.getS(),
					row[0]+1, row[3], row[4] == 1, row[5] == 1, row[6] == 1, row[7] == 1, row[8] == 1, row[9] == 1, row[0], row[1], row[2],
				)
				return
			}

			if cpu.PC != 2 || tstates != 15 {
				t.Errorf("got PC=%d, %d T-states, want PC=%d, %d T-states", cpu.PC, tstates, 2, 15)
			}
		}
	}
}
